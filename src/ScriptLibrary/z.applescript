on module()
	set libDirPath to POSIX path of ((path to me as text) & "::")
	set rh to "function Module(relativePath) {\n\tlet module = {exports: {}};\n\t((mod,rel)=>{\n"
	set rp to "\t\tlet p = '" & libDirPath & "'+ rel;"
	set rt to "\n\t\tlet u = $.NSUTF8StringEncoding;\n\t\tlet e1 = $();\n\t\tmod.contents = $.NSString.stringWithContentsOfFileEncodingError(p,u,e1).js;\n\t\tif (e1.js) {\n\t\t\tlet a = Application.currentApplication();\n\t\t\ta.includeStandardAdditions = true;\n\t\t\tlet t = a.pathTo(this);\n\t\t\tlet l = $(t.toString()).stringByDeletingLastPathComponent.js;\n\t\t\tif (l==='/usr/bin') {\n\t\t\t\tl = $.NSFileManager.defaultManager.currentDirectoryPath.js\n\t\t\t}\n\t\t\tlet p = l + '/' + rel;\n\t\t\tlet u = $.NSUTF8StringEncoding;\n\t\t\tlet e2 = $();\n\t\t\tmod.contents = $.NSString.stringWithContentsOfFileEncodingError(p,u,e2).js;\n\t\t\tif (e2.js) {\n\t\t\t\tlet p = $(rel).stringByStandardizingPath.js;\n\t\t\t\tlet u = $.NSUTF8StringEncoding;\n\t\t\t\tlet e3 = $();\n\t\t\t\tmod.contents = $.NSString.stringWithContentsOfFileEncodingError(p,u,e3).js;\n\t\t\t\tif (e3.js) {\n\t\t\t\t\tlet m = 'require():'\n\t\t\t\t\t\t\t+ '\\n\\n'\n\t\t\t\t\t\t\t+ $.NSString.stringWithFormat('%@', e1).js\n\t\t\t\t\t\t\t+ '\\n\\n'\n\t\t\t\t\t\t\t+ $.NSString.stringWithFormat('%@', e2).js\n\t\t\t\t\t\t\t+ '\\n\\n'\n\t\t\t\t\t\t\t+ $.NSString.stringWithFormat('%@', e3).js;\n\t\t\t\t\tconsole.log(m)\n\t\t\t\t\t$.NSLog(m)\n\t\t\t\t\tthrow new Error(m)\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t})(module,relativePath);\n\tlet exports = module.exports;\n\teval(module.contents);\n\treturn module.exports;\n}\n"
	return rh & rp & rt
end module
